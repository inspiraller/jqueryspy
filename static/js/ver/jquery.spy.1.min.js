//@Author: Steve Tomlin
//@Date: 11th June 2012
//@Version: 1
//@depends: jquery, qunit, sinon, sinon-qunit
//@licence: inherits from the above dependencies...
(function(e){var t=function(e){try{console.log(e)}catch(t){}};e.spy=function(e){var t=sinon.spy;return new n(t,e)};var n=function(e,t){this.model={arr:[]},this.strAjaxType=null,this.intExpectExtraPrivate=0,this.config={},this.config.intExpectExtra=0,this.config.intMaxWaitMS=4e3,this.config.intAjaxInterval=50,this.init(e,t)};n.prototype={strAjaxPossibles:",ajax,getJSON,",init:function(n,r){var i=this.configAndGetAjaxType(r);i&&(this.strAjaxType=i,n(e,i),console.log("is ajax - append intExpectExtraPrivate"),this.intExpectExtraPrivate+=1),this["init.recurseOptionsAndBuildTestArray"](r,0,"options"),t("this.model = "),t(this.model)},configAndGetAjaxType:function(e){var t=this.strAjaxPossibles,n,r=null;for(n in e)n==="config"?this.configCustom(e[n]):t.indexOf(","+n+",")!==-1&&(r=n);return this.config.hasOwnProperty("intMaxWaitSeconds")&&(this.config.intMaxWaitMS=this.configMaxWaitMS(this.config.intMaxWaitSeconds)),r},configCustom:function(e){var t;for(t in e)this.config[t]=e[t]},configMaxWaitMS:function(e){return e*1e3},"init.recurseOptionsAndBuildTestArray":function(e,n,r){var i;for(i in e)if(e.hasOwnProperty(i)&&(r!=="options"||i!=="config")){if(i==="views"){this.intExpectExtraPrivate-=1;var o=s.getObjLength(e[i]);this.intExpectExtraPrivate+=o,console.log("optionsEach["+i+"] = "),console.log(e[i]),console.log("length = "+o)}this["model.build"](i,e,n,r);var u=e[i];t(i+" ="+typeof u),typeof u=="object"&&this["init.recurseOptionsAndBuildTestArray"](u,n+1,i)}},"model.build":function(e,n,i,s){console.log("model.build()"),t("expectKey = "+e),r.hasOwnProperty(e)?this.model.arr.push({testName:e,expectKey:e,expectParam:n[e]}):r.hasOwnProperty("ajax."+e)?this.model.arr.push({testName:"ajax."+e,expectKey:e,expectParam:n[e]}):this.strAjaxPossibles.indexOf(","+s+",")!==-1&&this.model.arr.push({testName:"ajaxCatchAll",expectKey:e,expectParam:n[e]})},run:function(){if(this.strAjaxType){var t=this.model.arr,n=t.shift(),s=n.testName,o=n.expectKey,u=n.expectParam,a=r[s],f=e.ajax.getCall(0),l=this.intExpectExtraPrivate+this.config.intExpectExtra;console.log(" this.intExpectExtraPrivate = "+this.intExpectExtraPrivate),a(t,this,f,o,u,l)}else{var c=this.model.arr;i(c)}}};var r={getJSON:function(){r.ajax.apply(this,arguments)},ajax:function(t,n,s,o,u,a){console.log("arrTests = "),console.log(t);var f=n.config.intMaxWaitMS,l=n.config.intAjaxInterval,c=e.ajax.calledOnce;ok(c,"Ajax has been called.");if(!c)return;var h=t.length+a;expect(h),stop();var p=(new Date).getTime(),d=function(){setTimeout(function(){var e=(new Date).getTime(),n=e-p,o=n>f;console.log("timeout intDifference= "+n),console.log("intMaxWaitMS = "+f),s.returnValue.status===200?(i(t,s),start(),v()):o?(r["ajax.incomplete"](f),start(),v()):d()},l)},v=function(){};d()},"ajax.incomplete":function(e){ok(!1,"Ajax exceeded time limit of "+e+" milliseconds.")},"ajax.success":function(e,t,n){console.log("ajax.success()"),console.log(arguments),console.log(n),ok(!0,"ajax responded successfully"),typeof n=="function"&&n()},ajaxCatchAll:function(e,t,n){console.log("ajaxCatchAll()"),console.log(n);var r=e.args[0][t];if(n!==""){var i=",get,jsonp",o=RegExp("\\,"+s.encodeReg(n)+"\\,","g");i.search(o)!==-1&&(r=r.toLowerCase(),n=n.toLowerCase())}equals(r,n," Ajax options: "+t)},"ajax.views":function(n,i,s){t("ajax.views() ...");for(var o=0,u=s.length;o<u;++o){var a=s[o],f=a.el;t("strEl = "+f);if(f){var l=e(f);ok(l.length,"element "+f+" exists"),t("ran test above "),r["ajax.views.each"](l,a)}else ok(!1,"property el not provided for view "+o)}},"ajax.views.each":function(e,n){var i,o,u,a=!0;for(i in n){if(a){a=!1;continue}var f=n[i];if(typeof f=="object")r["ajax.views.each.objectAsValue"](e,f,i);else if(s.isVarLiteral(f)){if(!e[i]){t("this is not supported el["+i+"]()");continue}o=e[i](),u=f,equals(o,u,"view el["+i+"]() === "+u)}else t("this is not supported = el["+i+"]()")}},"ajax.views.each.objectAsValue":function(e,n,r){var i,o,u;for(i in n){u=n[i];if(!s.isVarLiteral(u)){t("This is not supported =  el["+r+"]("+i+")");continue}o=e[r](i),equals(o,u,"view el["+r+"]("+i+") === "+u)}}},i=function(e){var t=arguments.length>1?arguments[1]:null;for(var n=0,i=e.length;n<i;++n){var s=e[n],o=s.testName,u=s.expectParam,a=s.expectKey,f=r[o];f(t,a,u)}},s={encodeReg:function(e){return(""+e).replace(/([^\w\d\s])/g,"\\$1")},isVarLiteral:function(e){return typeof e=="string"||typeof e=="boolean"||typeof e=="number"},getObjLength:function(e){var t,n,r=0;for(var i=0,s=e.length;i<s;++i){t=e[i];for(n in t)t.hasOwnProperty(n)&&++r}return r}};e.spy=e.spy})($)